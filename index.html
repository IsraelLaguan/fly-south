<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="origin-trial">
<title>FlySouth</title>
<script src="node_modules/aframe/dist/aframe-master.js"></script>
<body class="a-body ">
<a-scene class="fullscreen" canvas vr-mode-ui fog="type: exponential; color: #87CEFA; density: 0.02;">
    <a-assets>
        <a-plane id="street" material="color:#333;"></a-plane>
        <a-box id="building" material="color:#a1b7dc; metalness:0.3;"></a-box>
    </a-assets>

    <a-entity id="world">
        <a-entity id="streets"></a-entity>
        <a-entity id="buildings"></a-entity>
    </a-entity>

    <a-entity id="park 1" position="325 0.1 325">
        <a-plane color="#2cb037" position="0 0 0" geometry="primitive: plane; height: 45; width: 45" rotation="270 0 0"></a-plane>
        <a-circle color="#d9c4aa" position="0 0.1 0" geometry="primitive: circle; radius: 10" rotation="270 0 0"></a-circle>
        <a-entity id="tree" position="3 0 4">
            <a-box position="0 0.5 0" open-ended="true" material="color:#6B4226;"></a-box>
            <a-cone id="tree" position="0 6 0" color="#143306" radius-bottom="2" height="10" segments-height="2" segments-radial="4"></a-cone>
        </a-entity>
        <a-entity id="tree" position="-3 0 -4">
            <a-box position="0 2 0" open-ended="true" height="4" material="color:#6B4226;"></a-box>
            <a-box position="0 6 0" open-ended="true" width="4" height="4" depth="4" material="color:#143306;"></a-box>
        </a-entity>
    </a-entity>

    <a-entity id="park 2" position="325 0.1 275">
        <a-plane color="#2cb037" position="0 0 0" geometry="primitive: plane; height: 45; width: 45" rotation="270 0 0"></a-plane>
    </a-entity>

    <a-entity id="player">
        <a-camera id="camera" far="10000"></a-camera>
    </a-entity>

    <a-entity id="intro-room">
        <a-entity id="intro-1">
            <a-text position="0 2 -3" align="center" color="black" value="You are a goose and it's getting cold."></a-text>
            <a-text position="0 1.7 -3" opacity="0.5" align="center" color="black" value="Turn right --->"></a-text>
        </a-entity>

        <a-entity id="intro-2">
            <a-text position="3 2 0" rotation="0 -90 0" align="center" color="black" value="The other geese left for south but you are still hungry."></a-text>
            <a-text position="3 1.7 0" opacity="0.5" rotation="0 -90 0" align="center" color="black" value="--->"></a-text>
        </a-entity>

        <a-entity id="intro-3">
            <a-text position="0 2 3" rotation="0 180 0" align="center" color="black" value="Find the nearby park to eat."></a-text>
            <a-text position="0 1.7 3" opacity="0.5" rotation="0 180 0" align="center" color="black" value="--->"></a-text>
        </a-entity>

        <a-entity id="intro-4">
            <a-text position="-3 2 0" rotation="0 90 0" align="center" color="black" value="Look up to take off."></a-text>
            <a-text position="-3 1.7 0" opacity="0.5" rotation="0 90 90" align="center" color="black" value="--->"></a-text>
        </a-entity>

        <a-text position="-1.3 0.6 -1" opacity="0.5" rotation="0 70 90" align="center" color="black" value="----->"></a-text>
    </a-entity>

    <a-plane id="ground" color="#ccf" position="0 -0.1 0" geometry="primitive: plane; height: 5000; width: 5000" rotation="270 0 0"></a-plane>
    <a-sky material="shader: flat; color: #000" geometry="radius: 4000" segments-height="2" segments-width="4"></a-sky>
    <a-light type="directional" color="#fff" intensity="0.2" position="-1 2 1" light=""></a-light>
    <a-light type="ambient" color="#fff" light=""></a-light>
</a-scene>
<script>
'use strict';

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function clearChildren(parent) {
    while (parent.firstChild) {
        parent.removeChild(myNode.firstChild);
    }
}

// Settings
const BLOCKS = 10;
const BLOCKSIZE = 50;
const BLG_MIN_HEIGHT = 10;
const BLG_MAX_HEIGHT = 60;

// === scene wrappers ===
var scene = document.querySelector('a-scene');
var ground = document.getElementById('ground');
var sky = document.querySelector('a-sky');
var streets = document.getElementById('streets');
var buildings = document.getElementById('buildings');

var intro = document.getElementById('intro-room');

// === player objects ===
var player = document.getElementById('player');
var player_animation = document.getElementById('player_animation');
var camera = document.getElementById('camera');

var south = 0;
var currentStage;

function startLevel1() { // City
    currentStage = INTRO;
    continueStanding();

    // Determine south
    south = Math.random() * 350 + 5;
    const startCrossing = {x: randomInt(1, 10), y: randomInt(1, 10) };
    const x = startCrossing.x * BLOCKSIZE;
    const z = startCrossing.y * BLOCKSIZE;
    player.object3D.position.set(x, 0.4, z);

    clearChildren(streets);
    clearChildren(buildings);

    for(let i = 0; i < BLOCKS + 1; i++) {
        // Main roads
        const roadLength = BLOCKS * BLOCKSIZE;
        addStreet(createStreet([i * BLOCKSIZE, 0], [i * BLOCKSIZE, roadLength], 6));
        addStreet(createStreet([0, i * BLOCKSIZE], [roadLength, i * BLOCKSIZE], 6));
        // Service roads
        //addStreet(createStreet([i * 50+25, 0], [i * 50+25, 0], 4));
    }

    for(let x = 0; x < BLOCKS; x++) {
        for(let y = 0; y < 10; y++) {
            if (x === 6 && (y === 5 || y === 6)) continue; // leave empty for the park
            const buildingX = x * BLOCKSIZE + (BLOCKSIZE / 2);
            const buildingY = y * BLOCKSIZE + (BLOCKSIZE / 2);
            const buildingWidth = BLOCKSIZE - 10;
            const height = Math.random() * (BLG_MAX_HEIGHT - BLG_MIN_HEIGHT) + BLG_MIN_HEIGHT;
            addBuilding(createBuilding([buildingX, buildingY], buildingWidth, buildingWidth, height));
        }
    }
}

function startLevel2() { // Clouds
    player.object3D.position.set(x, 0, z);

    clearChildren(streets);
    clearChildren(buildings);
}

function startLevel3() { // Clouds
    player.object3D.position.set(x, 0, z);
}

function createStreet([x1,y1], [x2,y2], width = 5) {
    const value_street = document.getElementById('street');
    const newStreet = value_street.cloneNode(true);
    const deltaX = x2 - x1;
    const deltaY = y2 - y1;
    const avrX = x1 + deltaX / 2;
    const avrY = y1 + deltaY / 2;
    const length = Math.hypot(deltaX, deltaY);
    newStreet.setAttribute('height', length);
    newStreet.setAttribute('width', width);
    newStreet.setAttribute('position', {x:avrX, y:0.3, z:avrY});
    const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
    newStreet.setAttribute('rotation', {x:270, y:0, z:angle+90});
    return newStreet;
}

function createBuilding([x1,y1], width, length, height) {
    const value_building = document.getElementById('building');
    const newBuilding = value_building.cloneNode(true);
    newBuilding.setAttribute('width', width);
    newBuilding.setAttribute('depth', length);
    newBuilding.setAttribute('height', height);
    newBuilding.setAttribute('position', {x:x1, y:height/2, z:y1});
    return newBuilding;
}

const addStreet=street=>streets.appendChild(street);
const addBuilding=building=>buildings.appendChild(building);


const INTRO = 0;
const TAKEOFF = 1;
const FLYING = 2;
const LANDING = 3;
const GROUND = 4;
const EATING = 5; // Standing and eating
const HEAVEN = 6;

setTimeout(() => startLevel1());

function angleWithinRange(actual, expected, variation) {
    actual %= 360;
    actual += 360;
    actual %= 360;
    console.log(actual, expected);
    if (actual > expected - variation && actual < expected + variation) {
        return true;
    }
    //TODO Wrap around 360째 to 0째 and 0째 to 360째
    return false;
}

function continueStanding() {
    setTimeout(standingLoop, 100);
}

function continueFlying() {
    requestAnimationFrame(flyingingLoop);
}

function standingLoop() {
    switch(currentStage) {
        case INTRO:
            const rot_x = camera.getAttribute('rotation').x;
            if (rot_x > 85) {
                currentStage = FLYING;
                clearInterval(standingInterval);
                requestAnimationFrame(nextStageChecker);
                scene.setAttribute('fog', {density:0.01});
            }
            break;
    }
}

function flyingingLoop(timestamp) {
    if (!lastTimestamp) lastTimestamp = timestamp;
    const deltaSeconds = (timestamp - lastTimestamp) / 1000;
    lastTimestamp = timestamp;
    const speed = -5;
    const pos = player.getAttribute('position');
    const org_rotation = player.object3D.rotation;
    const cam_rotation = camera.getAttribute('rotation');

    if (angleWithinRange(cam_rotation.y, south, 5)) {
        startedFlyingSouth(timestamp);
    } else {
        stoppedFlyingSouth();
    }

    player.setAttribute('rotation', cam_rotation);
    player.object3D.translateZ(deltaSeconds * speed);
    player.setAttribute('rotation', {x:0, y:0, z:0});

    const player_position = camera.getAttribute('position');
    if (player_position.y > 100) {
        player_position.y = 100;
    } else if (player_position.y < 0) {
        die('ground');
    }
    requestAnimationFrame(nextStageChecker);
}

var flyingSouth = false;
var flyingSouthTimeout = null;
var flyingSouthSkyAnimation = null;

function startedFlyingSouth() {
    if (flyingSouth === false) {
        flyingSouth = true;
        console.log('started flying south');
        flyingSouthSkyAnimation = document.createElement('a-animation');
        flyingSouthSkyAnimation.setAttribute('attribute', 'fog.color');
        flyingSouthSkyAnimation.setAttribute('dur', '10000');
        flyingSouthSkyAnimation.setAttribute('from', '#87CEFA');
        flyingSouthSkyAnimation.setAttribute('to', '#fd5e53');
        scene.appendChild(flyingSouthSkyAnimation);
        flyingSouthTimeout = setTimeout(winGame, 10000);
    }
}

function stoppedFlyingSouth() {
    if (flyingSouth === true) {
        flyingSouth = false;
        console.log('stopped flying south');
        while (flyingSouthSkyAnimation) {
            scene.removeChild(flyingSouthSkyAnimation);
            flyingSouthSkyAnimation = null;
        }
        if (!flyingSouthTimeout) {
            clearInterval(flyingSouthTimeout);
        }
    }
}

function winGame() {
    //TODO Do something to celebrate the win.
    console.log('You won the game!');
}

var lastTimestamp = null;



// addStreet(createStreet([0,0], [40,0]));
// addStreet(createStreet([20,0], [20,20]));
// addStreet(createStreet([20,20], [0,20]));
// addStreet(createStreet([0,20], [0,0]));
//
// addStreet(createStreet([20,10], [0,0], 1));
// addStreet(createStreet([0,0], [20,20], 2));

</script>
</body></html>
