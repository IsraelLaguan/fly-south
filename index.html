<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="origin-trial">
<title>FlySouth</title>
<script src="node_modules/aframe/dist/aframe-master.js"></script>
<body class="a-body ">
<a-scene class="fullscreen" canvas vr-mode-ui fog="type: exponential; color: #87CEFA; density: 0.02;">
    <a-assets>
        <a-plane id="street" material="color:#333;"></a-plane>
        <a-box id="building" material="color:#a1b7dc; metalness:0.3;"></a-box>
    </a-assets>

    <a-entity id="world">
        <a-entity id="streets"></a-entity>
        <a-entity id="buildings"></a-entity>
    </a-entity>

    <a-entity id="player" look-controls-enabled>
        <a-camera id="camera" far="10000"></a-camera>
        <a-entity id="map-wrapper">
            <a-text position="-0.3 0.4 0" rotation="-90 90 0" align="center" color="black" value="[Map]" wrap-count="7" width="1.6"></a-text>
            <a-text position="0 0.4 0" rotation="-90 90 0" align="center" color="black" value="[Enabled in flight]" wrap-count="30"  width="1.6"></a-text>
            <a-plane position="0 0.35 0" opacity="0.5" rotation="-90 90 0" width="1.7" height="1.7" color="#eee" value="--->"></a-plane>
        </a-entity>
    </a-entity>

    <a-entry id="intro-room">
        <a-entry id="intro-1">
            <a-text position="0 2 -3" align="center" color="black" value="You are a goose and it's getting cold."></a-text>
            <a-text position="0 1.7 -3" opacity="0.5" align="center" color="black" value="Turn right --->"></a-text>
        </a-entry>

        <a-entry id="intro-2">
            <a-text position="3 2 0" rotation="0 -90 0" align="center" color="black" value="The other geese left for south but you are still hungry."></a-text>
            <a-text position="3 1.7 0" opacity="0.5" rotation="0 -90 0" align="center" color="black" value="--->"></a-text>
        </a-entry>

        <a-entry id="intro-3">
            <a-text position="0 2 3" rotation="0 180 0" align="center" color="black" value="Use the map to find the park and then fly south."></a-text>
            <a-text position="0 1.7 3" opacity="0.5" rotation="0 180 0" align="center" color="black" value="--->"></a-text>
        </a-entry>

        <a-entry id="intro-4">
            <a-text position="-3 2 0" rotation="0 90 0" align="center" color="black" value="The map is underneath you."></a-text>
            <a-text position="-3 1.7 0" opacity="0.5" rotation="0 90 -90" align="center" color="black" value="--->"></a-text>
        </a-entry>

        <a-entry id="intro-5">
            <a-text position="-1.4 0.4 0" rotation="-50 90 0" align="center" color="black" value="Look up to take off."></a-text>
            <!--<a-text position="1.4 0.4 0" rotation="-50 270 0" align="center" color="black" value="Look up to take off."></a-text>
            <a-text position="0 0.4 -1.4" rotation="-50 0 0" align="center" color="black" value="Look up to take off."></a-text>
            <a-text position="0 0.4 1.4" rotation="-50 180 0" align="center" color="black" value="Look up to take off."></a-text>-->
        </a-entry>

        <a-text position="-1.3 0.6 -1" opacity="0.5" rotation="0 70 90" align="center" color="black" value="----->"></a-text>
    </a-entry>

    <a-plane color="#ccf" position="0 -0.1 0" geometry="primitive: plane; height: 5000; width: 5000" rotation="270 0 0"></a-plane>
    <a-sky material="shader: flat; color: #87CEFA;" geometry="primitive: sphere; radius: 5000; segmentsHeight: 20; segmentsWidth: 64"></a-sky>
    <a-light type="directional" color="#fff" intensity="0.2" position="-1 2 1" light=""></a-light>
    <a-light type="ambient" color="#fff" light=""></a-light>
</a-scene>
<script>
'use strict';

var scene = document.querySelector('a-scene');
var sky = document.querySelector('a-sky');

var streets = document.getElementById('streets');
var buildings = document.getElementById('buildings');

var player = document.getElementById('player');
var player_animation = document.getElementById('player_animation');
var camera = document.getElementById('camera');

var south = Math.random() * 360;

var map_wrapper = document.getElementById('player');

function setCamera(position, targetPosition, duration) {
    player.setAttribute('position', targetPosition);
    //if (targetPosition && duration) {
    //    player_animation.setAttribute('to', targetPosition);
    //    player_animation.setAttribute('duration', duration);
    //    lastPosition = targetPosition;
    //}
}

function createStreet([x1,y1], [x2,y2], width = 5) {
    const value_street = document.getElementById('street');
    const newStreet = value_street.cloneNode(true);
    const deltaX = x2 - x1;
    const deltaY = y2 - y1;
    const avrX = x1 + deltaX / 2;
    const avrY = y1 + deltaY / 2;
    const length = Math.hypot(deltaX, deltaY);
    newStreet.setAttribute('height', length);
    newStreet.setAttribute('width', width);
    newStreet.setAttribute('position', {x:avrX, y:0.3, z:avrY});
    const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
    newStreet.setAttribute('rotation', {x:270, y:0, z:angle+90});
    return newStreet;
}

function createBuilding([x1,y1], width, length, height) {
    const value_building = document.getElementById('building');
    const newBuilding = value_building.cloneNode(true);
    newBuilding.setAttribute('width', width);
    newBuilding.setAttribute('depth', length);
    newBuilding.setAttribute('height', height);
    newBuilding.setAttribute('position', {x:x1, y:height/2, z:y1});
    return newBuilding;
}

const addStreet=street=>streets.appendChild(street);
const addBuilding=building=>buildings.appendChild(building);


for(let i = 0; i < 10; i++) {
    // Main roads
    addStreet(createStreet([i * 50, 0], [i * 50,500], 6));
    addStreet(createStreet([0, i * 50], [500,i * 50], 6));
    // Service roads
    addStreet(createStreet([i * 50+25, 0], [i * 50+25, 0], 4));
}

for(let x = 0; x < 10; x++) {
    for(let y = 0; y < 10; y++) {
        addBuilding(createBuilding([x * 50 + 25, y * 50 + 25], 40, 40, Math.random() * 60 + 10));
    }
}
const INTRO = 0;
const TAKEOFF = 1;
const FLYING = 2;
const LANDING = 3;
const GROUND = 4;
const EATING = 5; // Standing and eating
const HEAVEN = 6;

let currentStage = INTRO;
let lastPosition = {x: 0, y: 0.3, z:0};
let targetPosition = {x: 0, y: 0.3, z:0};

setCamera(lastPosition);

function angleWithinRange(actual, expected, variation) {
    actual %= 360;
    actual += 360;
    actual %= 360;
    console.log(actual, expected);
    if (actual > expected - variation && actual < expected + variation) {
        return true;
    }
    //TODO Wrap around 360째 to 0째 and 0째 to 360째
    return false;
}

function nextStageChecker(timestamp) {
    switch(currentStage) {
        case INTRO:
            const rot_x = camera.getAttribute('rotation').x;
            if (rot_x > 85) {
                currentStage = FLYING;
                clearInterval(interval);
                requestAnimationFrame(nextStageChecker);
                scene.setAttribute('fog', {density:0.01});
            }
            break;
        case FLYING:
            if (!lastTimestamp) lastTimestamp = timestamp;
            const deltaSeconds = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;
            const speed = -5;
            const pos = player.getAttribute('position');
            const org_rotation = player.object3D.rotation;
            const cam_rotation = camera.getAttribute('rotation');
            if (angleWithinRange(cam_rotation.y, south, 5)) {
                startedFlyingSouth(timestamp);
            } else {
                stoppedFlyingSouth();
            }
            player.setAttribute('rotation', cam_rotation);
            player.object3D.translateZ(deltaSeconds * speed);
            player.setAttribute('rotation', {x:0, y:0, z:0});
            const player_position = camera.getAttribute('position');
            if (player_position.y > 100) {
                player_position.y = 100;
            } else if (player_position.y < 0) {
                die('ground');
            }
            requestAnimationFrame(nextStageChecker);
    }
}

var flyingSouth = false;
var flyingSouthTimeout = null;
var flyingSouthSkyAnimation = null;

function startedFlyingSouth() {
    if (flyingSouth === false) {
        flyingSouth = true;
        console.log('started flying south');
        flyingSouthSkyAnimation = document.createElement('a-animation');
        flyingSouthSkyAnimation.setAttribute('attribute', 'fog.color');
        flyingSouthSkyAnimation.setAttribute('dur', '10000');
        flyingSouthSkyAnimation.setAttribute('from', '#87CEFA');
        flyingSouthSkyAnimation.setAttribute('to', '#fd5e53');
        scene.appendChild(flyingSouthSkyAnimation);
        flyingSouthTimeout = setTimeout(winGame, 10000);
    }
}

function stoppedFlyingSouth() {
    if (flyingSouth === true) {
        flyingSouth = false;
        console.log('stopped flying south');
        while (flyingSouthSkyAnimation) {
            scene.removeChild(flyingSouthSkyAnimation);
            flyingSouthSkyAnimation = null;
        }
        if (!flyingSouthTimeout) {
            clearInterval(flyingSouthTimeout);
        }
    }
}

function winGame() {
    //TODO Do something to celebrate the win.
    console.log('You won the game!');
}

var lastTimestamp = null;

var interval = setInterval(nextStageChecker, 50);

// addStreet(createStreet([0,0], [40,0]));
// addStreet(createStreet([20,0], [20,20]));
// addStreet(createStreet([20,20], [0,20]));
// addStreet(createStreet([0,20], [0,0]));
//
// addStreet(createStreet([20,10], [0,0], 1));
// addStreet(createStreet([0,0], [20,20], 2));

</script>
</body></html>
